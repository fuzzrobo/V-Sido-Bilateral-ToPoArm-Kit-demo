# 4.データ収集

## hugging faceのアカウント作成

Hugging faceのアカウント作成し，トークンを取得します．トークンは，write-access tokenを取得することに注意してください．
[hugging face トークン取得画面](https://huggingface.co/settings/tokens)


token名は任意(ここではfuzzrobo_topoarm)です．

```
トークン名
fuzzrobot_topoarm

トークン (メモしてください)
**************************
```

トークンをPCに追加します

```
git config --global credential.helper store

# 自分のトークン名(**************************)をトークンに変えて入力してください．
huggingface-cli login --token ************************** --add-to-git-credential

# ****はhuggingfaceに登録したユーザー名
HF_USER=$(huggingface-cli whoami | head -n 1)
HF_USER=****
```

データ収集でpermission deniedと表示された場合，whoamiと，HF_USERを再度実行する．

## データ収集

episodeのrecord方法


```
cd lerobot/src
```

カメラ1個の例

```
python lerobot/topoarm_record.py \
  --robot.type=topoarm_follower \
  --robot.id=my_topoarm_follower \
  --robot.cameras="{ front: {type: opencv, index_or_path: /dev/video0, width: 640, height: 480, fps: 30}}" \
  --teleop.type=topoarm_leader \
  --teleop.id=my_topoarm_leader \
  --display_data=true \
  --dataset.repo_id=${HF_USER}/topo_test1014_1 \
  --dataset.num_episodes=15 \
  --dataset.episode_time_s=10 \
  --dataset.reset_time_s=5 \
  --dataset.single_task="topo_test1014_1"
```

カメラ2個の例

```
python lerobot/topoarm_record.py \
  --robot.type=topoarm_follower \
  --robot.id=my_topoarm_follower \
  --robot.cameras='{top:  {type: opencv, index_or_path: "/dev/video2", width: 640, height: 480, fps: 30},
                    side: {type: opencv, index_or_path: "/dev/video4", width: 640, height: 480, fps: 20}}' \
  --teleop.type=topoarm_leader \
  --teleop.id=my_topoarm_leader \
  --display_data=true \
  --dataset.repo_id=${HF_USER}/topo_test1014_2 \
  --dataset.num_episodes=2 \
  --dataset.episode_time_s=8 \
  --dataset.reset_time_s=5 \
  --dataset.single_task="topo_test1014_2"
```




### パラメータの役割

カメラの名前，レコードするファイル名を設定してください．

| パラメータ名 | 役割 |
| --- | --- |
| dev/video0, 2... | カメラの名前 |
| repo_id | 記録ファイルの名前 |
| num_episode | レコードするエピソード数 |
| episode_time_s | 一回のデータ収集時間 |
| reset_time_s | 環境を整える時間 |
| single_task | タスクの名前 |

記録中に流れる音声の種類

| 音声 | 意味 | 操作するタイミング |
| --- | --- | --- |
| Recording episode | エピソードのレコードを開始 | 言いはじめのタイミング |
| Reset the environment | 環境を元通りにする | 言い終わったタイミング |
| Stop the recording | レコードを終了 |  |
| Exiting | 終了 |  |


### 保存先の確認

テストデータが重複してとれないときは、ここから削除を実行します
    
```
cd /home/<user_name>/.cache/huggingface/lerobot/<your_name>/
# 例
cd .cache/huggingface/lerobot/hEnka11900/

# 削除
rm -rf pick_bottle_cap/
```

### 映像の確認

```
cd .cache/huggingface/lerobot/$HF_USER/<your_task>/videos/chunk-000/observation.images.front
# 例
cd .cache/huggingface/lerobot/hEnka11900/topo_test1014_2/videos/chunk-000/observation.images.front

ffplay -vcodec libdav1d episode_000000.mp4
```
</details>


### もう一度学習データを取り直す場合
次のコマンドでデータセットを消去
```
rm -rf ~/.cache/huggingface/lerobot/$HF_USER/topo_test1014_2
```




### 関節角度が記録されているか確認
```
# データ確認
python3 lerobot/check.py $HF_USER/topo_test1014_2
# 例
python3 lerobot/check.py hEnka11900/topo_test1014_2

# 各エピソードの角度確認
python3 lerobot/check_joint_motion.py $HF_USER/topo_test1014_2
# 例
python3 lerobot/check_joint_motion.py hEnka11900/topo_test1014_2
```  
    

### データのアップロード
HFのサーバにアップしたければ実行．必須ではない

```
echo https://huggingface.co/datasets/${HF_USER}/topo_test2
echo ${HF_USER}/topo_test2
```



### トラブルシューティング

カメラのエラー
- USBハブのケーブルが長過ぎる
- ハブにものをつなぎすぎると電力不足で落ちたりする

rerunがない
```
pip3 install rerun-sdk==0.23.4
```
