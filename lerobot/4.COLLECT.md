# データ収集

## hugging faceのアカウント作成

トークンを取得・write-access tokenを取得することに注意。

Token typeでwriteを選ぶことに注意。

token名は自分で適当に決める

[](https://huggingface.co/settings/tokens)

トークンはメモ

```
トークン名
fuzz_topoarm

トークン
**************************
```

トークンを追加

```
git config --global credential.helper store
# 自分のトークン名を入力
huggingface-cli login --token ************************** --add-to-git-credential

# ****はhuggingfaceに登録したユーザー名
HF_USER=****
```

## データ収集

episodeのrecord方法

カメラの名前を合わせる

```
cd lerobot/src
```

カメラ1個の例

```
python lerobot/topoarm_record.py \
  --robot.type=topoarm_follower \
  --robot.id=my_topoarm_follower \
  --robot.cameras="{ front: {type: opencv, index_or_path: /dev/video0, width: 640, height: 480, fps: 30}}" \
  --teleop.type=topoarm_leader \
  --teleop.id=my_topoarm_leader \
  --display_data=true \
  --dataset.repo_id=${HF_USER}/topo_test1014_1 \
  --dataset.num_episodes=15 \
  --dataset.episode_time_s=10 \
  --dataset.reset_time_s=5 \
  --dataset.single_task="topo_test1014_1"
```

カメラ2個の例

```
python lerobot/topoarm_record.py \
  --robot.type=topoarm_follower \
  --robot.id=my_topoarm_follower \
  --robot.cameras='{top:  {type: opencv, index_or_path: "/dev/video2", width: 640, height: 480, fps: 30},
                    side: {type: opencv, index_or_path: "/dev/video4", width: 640, height: 480, fps: 20}}' \
  --teleop.type=topoarm_leader \
  --teleop.id=my_topoarm_leader \
  --display_data=true \
  --dataset.repo_id=${HF_USER}/topo_test1014_3 \
  --dataset.num_episodes=2 \
  --dataset.episode_time_s=8 \
  --dataset.reset_time_s=5 \
  --dataset.single_task="topo_test1014_3"
```

USBハブのケーブルが長過ぎる or ハブにものをつなぎすぎると電力不足で落ちたりする

カメラの位置を示すtopやsideは必要に応じて変更

エラーが出る場合

```
pip3 install rerun-sdk==0.23.4
```

もう一度学習データを取り直す場合

```
rm -rf ~/.cache/huggingface/lerobot/$HF_USER/topo_test1014_2
```

- パラメータ、キーボード操作、音声等
    
    パラメータ
    
    | num_episode | レコードするエピソード数 |
    | --- | --- |
    | episode_time_s | 一回のデータ収集時間 |
    | reset_time_s | 環境を整える時間 |
    | resume | 再開するときはtrue |
    
    作業中のキーボード操作
    
    | 右矢印 | 現在のエピソードを早期停止するか、時間をリセットして次のエピソードに進みます。 |
    | --- | --- |
    | 左矢印 | 現在のエピソードをキャンセルして再録画します。 |
    | ESC | セッションが直ちに停止し、ビデオがエンコードされ、データセットがアップロードされます。 |
    
    音声がなり始めた瞬間操作し始めて良い。音声分も操作時間にカウントされている。
    
    |  |  | 操作するタイミング |
    | --- | --- | --- |
    | Recording episode | エピソードのレコードを開始 | 言いはじめのタイミング |
    | Reset the environment | 環境を元通りにする | 言い終わったタイミング |
    | Stop the recording | レコードを終了 |  |
    | Exiting | 終了 |  |
    
    参考
    
    [LeRobotとSO-ARMを使ったロボットアームの模倣学習の解説 - masato-ka's diary](https://masato-ka.hatenablog.com/entry/2025/05/04/183000)
    
    - 保存先の確認：テストデータが重複してとれないときは、ここから削除
        
        ```
        cd /home/<user_name>/.cache/huggingface/lerobot/<your_name>/
        # 例
        cd .cache/huggingface/lerobot/hEnka11900/
        
        # 削除
        rm -rf pick_bottle_cap/
        ```
        
- 映像の確認
    
    ```
    cd .cache/huggingface/lerobot/$HF_USER/<your_task>/videos/chunk-000/observation.images.front
    # 例
    cd .cache/huggingface/lerobot/hEnka11900/topo_test1014_2/videos/chunk-000/observation.images.front
    
    ffplay -vcodec libdav1d episode_000000.mp4
    ```
    
- 関節角度が記録されているか確認
    
    ```
    # データ確認
    python3 lerobot/check.py $HF_USER/topo_test1012_f
    # 例
    python3 lerobot/check.py hEnka11900/topo_test1014_3
    
    # 各エピソードの角度確認
    python3 lerobot/check_joint_motion.py $HF_USER/topo_test1012_f
    # 例
    python3 lerobot/check_joint_motion.py hEnka11900/topo_test1014_3
    
    ```
    
- アップロード
    
    HFのサーバにアップしたければ実行．必須ではない
    
    ```
    echo https://huggingface.co/datasets/${HF_USER}/topo_test2
    echo ${HF_USER}/topo_test2
    ```